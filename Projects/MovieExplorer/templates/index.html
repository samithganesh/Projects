<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Ratings Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body { padding: 20px;}
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
        }
        .card { padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>
    <h2><b>Movie Ratings Explorer</b></h2>

    <label>Choose genre:</label>
    <select id="genre"></select>
    <button id ="btn btn-primary btn-sm" onclick="refresh()">Refresh</button>

    <div class="grid">
        <div class="card">
            <h4>Top Movies</h4>
            <table class="table">
                <thead><tr><th>Title</th><th>Rating</th><th>Year</th></tr></thead>
                <tbody id="top-movies"></tbody>
            </table>
        </div>

        <div class="card">
            <h4>Average Rating by Genre</h4>
            <canvas id="avgChart"></canvas>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h4>Rating Distribution</h4>
            <canvas id="distChart"></canvas>
        </div>
    </div>

    <script>
        async function refresh() {
            const genre = document.getElementById("genre").value;

            // Top Movies
            let res = await fetch(`/top_movies?genre=${genre}&n=5`);
            let movies = await res.json();
            document.getElementById("top-movies").innerHTML =
                movies.map(m => `<tr><td>${m.title}</td><td>${m.rating.toFixed(1)}</td><td>${m.year}</td></tr>`).join("");

            // Average Ratings by Genre
            res = await fetch(`/avg_by_genre`);
            let avg = await res.json();
            new Chart(document.getElementById("avgChart"), {
                type: 'bar',
                data: {
                    labels: avg.map(x => x.genre),
                    datasets: [{ label: "Avg Rating", data: avg.map(x => x.rating) }]
                }
            });

            // Ratings Distribution
            res = await fetch(`/ratings_distribution?genre=${genre}`);
            let dist = await res.json();
            new Chart(document.getElementById("distChart"), {
                type: 'bar',
                data: {
                    labels: dist.bins,
                    datasets: [{ label: "Count", data: dist.counts }]
                }
            });
        }

        // Load genres at start
        (async () => {
            let res = await fetch(`/genres`);
            let genres = await res.json();
            let select = document.getElementById("genre");
            select.innerHTML = `<option value="">(All genres)</option>` +
                genres.map(g => `<option value="${g}">${g}</option>`).join("");
            refresh();
        })();
    </script>
</body>
</html>